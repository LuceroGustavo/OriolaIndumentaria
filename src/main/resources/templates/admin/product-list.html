<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Lista de Productos - ORIOLA</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Lista de Productos</h2>
            <a href="/admin/products/new" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Agregar Nuevo Producto
            </a>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Talle</th>
                        <th>Color</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Publicado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="product : ${products}">
                        <td th:text="${product.pId}"></td>
                        <td th:text="${product.name}"></td>
                        <td>
                            <span th:if="${product.categories != null and !product.categories.empty}" class="badge bg-info" th:text="${product.getCategoriasComoTexto()}"></span>
                            <span th:unless="${product.categories != null and !product.categories.empty}" class="text-muted">Sin categoría</span>
                        </td>
                        <td th:text="${product.getTemporadasComoTexto()}"></td>
                        <td>
                            <span th:if="${product.color}" th:text="${product.color}"></span>
                            <span th:unless="${product.color}" class="text-muted">-</span>
                        </td>
                        <td>$<span th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 2, 'POINT')}"></span></td>
                        <td>
                            <span th:if="${product.qty > 0}" class="badge bg-success" th:text="${product.qty}"></span>
                            <span th:if="${product.qty == 0}" class="badge bg-danger">Sin stock</span>
                        </td>
                        <td>
                            <span th:if="${product.activo}" class="badge bg-success">Publicado</span>
                            <span th:if="${!product.activo}" class="badge bg-secondary">Oculto</span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a th:href="@{/admin/products/edit/{id}(id=${product.pId})}" 
                                   class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button th:onclick="'toggleProductStatus(' + ${product.pId} + ', this)'" 
                                        th:class="'btn btn-sm ' + (${product.activo} ? 'btn-outline-warning' : 'btn-outline-success')"
                                        th:title="${product.activo ? 'Desactivar publicación' : 'Activar publicación'}"
                                        th:data-product-id="${product.pId}">
                                    <i th:class="${product.activo ? 'bi bi-eye-slash' : 'bi bi-eye'}"></i>
                                </button>
                                <a th:href="@{/admin/products/delete/{id}(id=${product.pId})}" 
                                   class="btn btn-sm btn-outline-danger"
                                   onclick="return confirm('¿Estás seguro de que quieres eliminar este producto?');" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(products)}">
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="bi bi-box-seam fs-1 d-block mb-2"></i>
                            No hay productos registrados
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function toggleProductStatus(productId, button) {
            if (confirm('¿Estás seguro de que quieres cambiar el estado de publicación de este producto?')) {
                fetch(`/admin/products/${productId}/toggle-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mostrar mensaje de éxito
                        showMessage('success', data.message);
                        
                        // Recargar la página para actualizar la vista
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showMessage('error', data.message || 'Error al cambiar el estado del producto');
                    }
                })
                .catch(error => {
                    showMessage('error', 'Error al cambiar el estado del producto: ' + error.message);
                });
            }
        }

        function showMessage(type, message) {
            // Crear elemento de mensaje
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Agregar al body
            document.body.appendChild(alertDiv);
            
            // Auto-remover después de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
